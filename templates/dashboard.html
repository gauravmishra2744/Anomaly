<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anomaly Detection - Cybersecurity</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: rgba(10,14,39,0.8);
            --text-primary: #e0e7ff;
            --text-secondary: #8b9dc3;
            --border-color: rgba(0,255,255,0.2);
            --accent-cyan: #00ffff;
            --accent-magenta: #ff00ff;
            --accent-green: #00ff88;
            --accent-red: #ff0055;
            --accent-orange: #ff6600;
            --accent-yellow: #ffaa00;
            --shadow-color: rgba(0,255,255,0.2);
            --gradient-start: rgba(0,255,255,0.1);
            --gradient-end: rgba(255,0,255,0.1);
        }
        body.light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #cbd5e1;
            --accent-cyan: #0ea5e9;
            --accent-magenta: #a855f7;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f97316;
            --accent-yellow: #eab308;
            --shadow-color: rgba(0,0,0,0.1);
            --gradient-start: rgba(14,165,233,0.1);
            --gradient-end: rgba(168,85,247,0.1);
        }
        body.light-mode .header h1,
        body.light-mode .card-title {
            background: linear-gradient(135deg, #0ea5e9 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        body.light-mode .stat-value {
            text-shadow: none;
        }
        body.light-mode .metric-value {
            text-shadow: none;
        }
        body {
            font-family: Rajdhani, sans-serif;
            background: var(--bg-primary);
            background-image: radial-gradient(at 0% 0%, var(--gradient-start) 0px, transparent 50%),
                              radial-gradient(at 100% 100%, var(--gradient-end) 0px, transparent 50%);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .theme-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .theme-toggle:hover {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            transform: scale(1.05);
        }
        .nav-link {
            color: var(--accent-cyan);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 600;
            border: 1px solid transparent;
        }
        .nav-link:hover {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
        }
        .header h1 {
            font-family: Orbitron, sans-serif;
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-badge {
            background: linear-gradient(135deg, #00ff88 0%, #00ffff 100%);
            color: #0a0e27;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 0 20px rgba(0,255,136,0.5);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px var(--shadow-color);
            transition: all 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-cyan);
            box-shadow: 0 10px 30px var(--shadow-color);
        }
        .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stat-title { font-size: 14px; color: #8b9dc3; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .stat-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .stat-value { font-family: Orbitron, sans-serif; font-size: 36px; font-weight: 700; margin-bottom: 5px; }
        body:not(.light-mode) .stat-value { text-shadow: 0 0 10px currentColor; }
        .stat-change { font-size: 13px; color: #6b7fa8; }
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px var(--shadow-color);
        }
        .footer {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 20px 30px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .footer-text {
            color: var(--text-secondary);
            font-size: 14px;
        }
        .footer-team {
            font-weight: 700;
            color: var(--accent-cyan);
            font-family: Orbitron, sans-serif;
        }
        .card-title {
            font-family: Orbitron, sans-serif;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-cyan);
        }
        body:not(.light-mode) .card-title {
            text-shadow: 0 0 10px rgba(0,255,255,0.5);
        }
        .input-group { margin-bottom: 20px; }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #8b9dc3;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 1px;
        }
        .input-group input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            color: var(--text-primary);
            font-family: Orbitron, sans-serif;
            transition: all 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px var(--shadow-color);
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: Rajdhani, sans-serif;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%);
            color: #0a0e27;
            box-shadow: 0 0 20px rgba(0,255,255,0.5);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(0,255,255,0.7); }
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--accent-cyan);
            border: 2px solid var(--accent-cyan);
        }
        .btn-secondary:hover { 
            background: var(--accent-cyan); 
            color: var(--bg-primary);
            transform: translateY(-2px);
        }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .result-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid var(--border-color);
            border-left: 4px solid var(--accent-cyan);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        .result-card.anomaly { border-left-color: var(--accent-red); }
        .result-card.normal { border-left-color: var(--accent-green); }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .result-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .result-badge.anomaly {
            background: linear-gradient(135deg, #ff0055 0%, #ff00ff 100%);
            color: white;
            box-shadow: 0 0 15px rgba(255,0,85,0.5);
        }
        .result-badge.normal {
            background: linear-gradient(135deg, #00ff88 0%, #00ffff 100%);
            color: #0a0e27;
            box-shadow: 0 0 15px rgba(0,255,136,0.5);
        }
        .result-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px; }
        .result-item { display: flex; justify-content: space-between; }
        .result-label { color: #8b9dc3; font-weight: 600; }
        .result-value { font-weight: 700; color: #00ffff; font-family: Orbitron, sans-serif; }
        .loading { display: none; text-align: center; padding: 40px; }
        .spinner {
            border: 4px solid rgba(0,255,255,0.1);
            border-top: 4px solid #00ffff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
            box-shadow: 0 0 20px rgba(0,255,255,0.5);
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
            border: 1px solid;
        }
        .alert-success {
            background: rgba(0,255,136,0.1);
            color: #00ff88;
            border-color: rgba(0,255,136,0.3);
            box-shadow: 0 0 20px rgba(0,255,136,0.2);
        }
        .alert-error {
            background: rgba(255,0,85,0.1);
            color: #ff0055;
            border-color: rgba(255,0,85,0.3);
            box-shadow: 0 0 20px rgba(255,0,85,0.2);
        }
        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .metric-item {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        .metric-label {
            font-size: 12px;
            color: #8b9dc3;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .metric-value {
            font-family: Orbitron, sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-cyan);
        }
        body:not(.light-mode) .metric-value {
            text-shadow: 0 0 10px rgba(0,255,255,0.5);
        }
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .footer-content { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-halved"></i> ANOMALY DETECTION SYSTEM</h1>
            <div class="header-controls">
                <a href="/about" class="nav-link"><i class="fas fa-info-circle"></i> About</a>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="themeIcon"></i>
                    <span id="themeText">Dark</span>
                </button>
                <div class="status-badge">
                    <i class="fas fa-circle-check"></i>
                    <span>ACTIVE</span>
                </div>
            </div>
        </div>
        
        <div class="alert alert-success" id="successAlert">
            <i class="fas fa-check-circle"></i>
            <span id="successMsg"></span>
        </div>
        
        <div class="alert alert-error" id="errorAlert">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorMsg"></span>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Total Samples</span>
                    <div class="stat-icon" style="color: #00ffff;">
                        <i class="fas fa-database"></i>
                    </div>
                </div>
                <div class="stat-value" id="totalSamples" style="color: #00ffff;">-</div>
                <div class="stat-change">Loaded from dataset</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Threats Detected</span>
                    <div class="stat-icon" style="color: #ff0055;">
                        <i class="fas fa-skull-crossbones"></i>
                    </div>
                </div>
                <div class="stat-value" id="anomaliesDetected" style="color: #ff0055;">-</div>
                <div class="stat-change">Flagged as anomalous</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Secure Samples</span>
                    <div class="stat-icon" style="color: #00ff88;">
                        <i class="fas fa-shield-check"></i>
                    </div>
                </div>
                <div class="stat-value" id="normalSamples" style="color: #00ff88;">-</div>
                <div class="stat-change">Within normal range</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Accuracy</span>
                    <div class="stat-icon" style="color: #ff00ff;">
                        <i class="fas fa-crosshairs"></i>
                    </div>
                </div>
                <div class="stat-value" id="accuracy" style="color: #ff00ff;">-</div>
                <div class="stat-change">Model performance</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-radar"></i>
                    THREAT ANALYSIS
                </h2>
                
                <div class="input-group">
                    <label for="sampleIdx">SAMPLE INDEX (0 - 16489)</label>
                    <input type="number" id="sampleIdx" value="0" min="0" max="16489">
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="predictSingle()">
                        <i class="fas fa-play"></i>
                        SCAN SINGLE
                    </button>
                    <button class="btn btn-primary" onclick="explainWithXAI()">
                        <i class="fas fa-brain"></i>
                        XAI EXPLAIN
                    </button>
                    <button class="btn btn-secondary" onclick="predictBatch()">
                        <i class="fas fa-layer-group"></i>
                        SCAN BATCH
                    </button>
                    <button class="btn btn-secondary" onclick="loadStatistics()">
                        <i class="fas fa-chart-line"></i>
                        STATISTICS
                    </button>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>SCANNING...</p>
                </div>
                
                <div id="results"></div>
            </div>
            
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-microchip"></i>
                    SYSTEM STATUS
                </h2>
                
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">Threshold</div>
                        <div class="metric-value" id="threshold" style="font-size: 16px;">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Mean Error</div>
                        <div class="metric-value" id="meanError" style="font-size: 16px;">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Std Dev</div>
                        <div class="metric-value" id="stdError" style="font-size: 16px;">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Model</div>
                        <div class="metric-value" style="font-size: 14px;">LSTM-AE</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" style="width: 100%;" onclick="exportReport()">
                        <i class="fas fa-file-export"></i>
                        EXPORT REPORT
                    </button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <div class="footer-content">
                <div class="footer-text">
                    &copy; 2025 Anomaly Detection System | Powered by LSTM-AE + XAI
                </div>
                <div class="footer-team">
                    Created by Team <span style="color: var(--accent-magenta);">Disruptors</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            document.getElementById('themeIcon').className = isLight ? 'fas fa-sun' : 'fas fa-moon';
            document.getElementById('themeText').textContent = isLight ? 'Light' : 'Dark';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }
        
        // Load saved theme
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
                document.getElementById('themeText').textContent = 'Light';
            }
        });
        
        loadDashboard();
        
        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showSuccess(msg) {
            const alert = document.getElementById('successAlert');
            document.getElementById('successMsg').textContent = msg;
            alert.style.display = 'flex';
            setTimeout(() => alert.style.display = 'none', 5000);
        }
        
        function showError(msg) {
            const alert = document.getElementById('errorAlert');
            document.getElementById('errorMsg').textContent = msg;
            alert.style.display = 'flex';
            setTimeout(() => alert.style.display = 'none', 5000);
        }
        
        function loadDashboard() {
            fetch('/api/dashboard')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('totalSamples').textContent = data.total_samples.toLocaleString();
                    document.getElementById('anomaliesDetected').textContent = data.anomalies_detected.toLocaleString();
                    document.getElementById('normalSamples').textContent = data.normal_samples.toLocaleString();
                    document.getElementById('accuracy').textContent = (data.accuracy * 100).toFixed(1) + '%';
                    document.getElementById('threshold').textContent = data.threshold.toFixed(6);
                    document.getElementById('meanError').textContent = data.error_mean.toFixed(6);
                    document.getElementById('stdError').textContent = data.error_std.toFixed(6);
                })
                .catch(err => showError('Error loading dashboard'));
        }
        
        function predictSingle() {
            const idx = parseInt(document.getElementById('sampleIdx').value);
            showLoading(true);
            
            fetch('/api/predict', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({sample_idx: idx})
            })
            .then(r => r.json())
            .then(data => {
                const status = data.prediction === 1 ? 'THREAT' : 'SECURE';
                const statusClass = data.prediction === 1 ? 'anomaly' : 'normal';
                const severityColor = data.severity === 'CRITICAL' ? '#ff0055' : 
                                     data.severity === 'HIGH' ? '#ff6600' :
                                     data.severity === 'MEDIUM' ? '#ffaa00' : '#00ff88';
                
                let factorsHtml = '';
                if (data.contributing_factors) {
                    factorsHtml = '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,255,255,0.2);">';
                    factorsHtml += '<strong style="color: #00ffff;">üîç Contributing Factors:</strong><ul style="margin: 10px 0 0 20px; color: #8b9dc3;">';
                    data.contributing_factors.forEach(f => {
                        factorsHtml += `<li style="margin: 5px 0;">${f}</li>`;
                    });
                    factorsHtml += '</ul></div>';
                }
                
                const html = `
                    <div class="result-card ${statusClass}">
                        <div class="result-header">
                            <h3>SAMPLE #${data.sample_idx}</h3>
                            <span class="result-badge ${statusClass}">${status}</span>
                        </div>
                        <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 3px solid ${severityColor};">
                            <strong style="color: ${severityColor};">Severity: ${data.severity || 'N/A'}</strong>
                        </div>
                        <div class="result-details">
                            <div class="result-item">
                                <span class="result-label">Error:</span>
                                <span class="result-value">${data.error.toFixed(6)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Threshold:</span>
                                <span class="result-value">${data.threshold.toFixed(6)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Confidence:</span>
                                <span class="result-value">${(data.confidence * 100).toFixed(1)}%</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Actual:</span>
                                <span class="result-value">${data.actual === 1 ? 'Threat' : 'Secure'}</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,255,255,0.2);">
                            <strong style="color: #00ffff;">üí° XAI Analysis:</strong> ${data.reason}
                        </div>
                        ${factorsHtml}
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="btn btn-secondary" onclick="explainWithXAI(${idx})" style="font-size: 12px;">
                                <i class="fas fa-brain"></i> DETAILED XAI REPORT
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('results').innerHTML = html;
                showLoading(false);
            })
            .catch(err => {
                showError('Error making prediction');
                showLoading(false);
            });
        }
        
        function explainWithXAI(idx = null) {
            const sampleIdx = idx !== null ? idx : parseInt(document.getElementById('sampleIdx').value);
            showLoading(true);
            
            fetch('/api/xai-explain', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({sample_idx: sampleIdx})
            })
            .then(r => r.json())
            .then(data => {
                const exp = data.explanation;
                const statusClass = exp.prediction === 'ANOMALY' ? 'anomaly' : 'normal';
                const severityColor = exp.severity === 'CRITICAL' ? '#ff0055' : 
                                     exp.severity === 'HIGH' ? '#ff6600' :
                                     exp.severity === 'MEDIUM' ? '#ffaa00' : '#00ff88';
                
                let timestepsHtml = '<div style="margin-top: 15px;"><strong style="color: #00ffff;">‚ö° Top Important Timesteps:</strong><div style="margin-top: 10px;">';
                exp.top_important_timesteps.slice(0, 5).forEach((ts, i) => {
                    const score = exp.top_importance_scores[i];
                    const barWidth = (score * 100 / Math.max(...exp.top_importance_scores)) * 100;
                    timestepsHtml += `
                        <div style="margin: 8px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px;">
                                <span style="color: #8b9dc3;">Timestep ${ts}</span>
                                <span style="color: #00ffff; font-family: Orbitron;">${score.toFixed(4)}</span>
                            </div>
                            <div style="background: rgba(0,255,255,0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #00ffff, #ff00ff); height: 100%; width: ${barWidth}%; border-radius: 3px;"></div>
                            </div>
                        </div>
                    `;
                });
                timestepsHtml += '</div></div>';
                
                let patternHtml = '<div style="margin-top: 15px;"><strong style="color: #00ffff;">üî¨ Pattern Analysis:</strong><div style="margin-top: 10px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">';
                const pa = exp.pattern_analysis;
                patternHtml += `
                    <div>Mean: <span style="color: #00ffff; font-family: Orbitron;">${pa.mean.toFixed(4)}</span></div>
                    <div>Std Dev: <span style="color: #00ffff; font-family: Orbitron;">${pa.std.toFixed(4)}</span></div>
                    <div>Volatility: <span style="color: #00ffff; font-family: Orbitron;">${pa.volatility.toFixed(4)}</span></div>
                    <div>Peaks: <span style="color: #00ffff; font-family: Orbitron;">${pa.peak_count}</span></div>
                    <div>Trend: <span style="color: #00ffff; font-family: Orbitron;">${pa.trend}</span></div>
                    <div>Concentration: <span style="color: #00ffff; font-family: Orbitron;">${(pa.anomaly_concentration * 100).toFixed(1)}%</span></div>
                `;
                patternHtml += '</div></div>';
                
                let factorsHtml = '<div style="margin-top: 15px;"><strong style="color: #00ffff;">üéØ Contributing Factors:</strong><ul style="margin: 10px 0 0 20px; color: #8b9dc3;">';
                exp.contributing_factors.forEach(f => {
                    factorsHtml += `<li style="margin: 5px 0;">${f}</li>`;
                });
                factorsHtml += '</ul></div>';
                
                const html = `
                    <div class="result-card ${statusClass}">
                        <div class="result-header">
                            <h3>üß† XAI EXPLAINABILITY REPORT - SAMPLE #${data.sample_idx}</h3>
                            <span class="result-badge ${statusClass}">${exp.prediction}</span>
                        </div>
                        <div style="margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 4px solid ${severityColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: ${severityColor}; font-size: 16px;">Severity: ${exp.severity}</strong>
                                <span style="color: #00ffff; font-family: Orbitron;">Confidence: ${(exp.confidence * 100).toFixed(1)}%</span>
                            </div>
                            <div style="color: #e0e7ff; line-height: 1.6;">${exp.reason}</div>
                        </div>
                        <div class="result-details">
                            <div class="result-item">
                                <span class="result-label">Reconstruction Error:</span>
                                <span class="result-value">${exp.reconstruction_error.toFixed(6)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Threshold:</span>
                                <span class="result-value">${exp.threshold.toFixed(6)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Error Ratio:</span>
                                <span class="result-value">${exp.error_ratio.toFixed(2)}x</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">XAI Enabled:</span>
                                <span class="result-value" style="color: #00ff88;">‚úì YES</span>
                            </div>
                        </div>
                        ${timestepsHtml}
                        ${patternHtml}
                        ${factorsHtml}
                    </div>
                `;
                document.getElementById('results').innerHTML = html;
                showSuccess('XAI Explanation Generated Successfully');
                showLoading(false);
            })
            .catch(err => {
                showError('Error generating XAI explanation');
                showLoading(false);
            });
        }
        
        function predictBatch() {
            const startIdx = parseInt(document.getElementById('sampleIdx').value);
            showLoading(true);
            
            fetch('/api/batch-predict', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({start_idx: startIdx, batch_size: 10})
            })
            .then(r => r.json())
            .then(data => {
                let html = '<h3 style="margin-bottom: 15px; color: #00ffff;">BATCH SCAN RESULTS</h3>';
                data.predictions.forEach(pred => {
                    const statusClass = pred.prediction === 1 ? 'anomaly' : 'normal';
                    const status = pred.prediction === 1 ? 'THREAT' : 'SECURE';
                    html += `
                        <div class="result-card ${statusClass}" style="margin-bottom: 10px;">
                            <div class="result-header">
                                <span><strong>SAMPLE #${pred.idx}</strong></span>
                                <span class="result-badge ${statusClass}">${status}</span>
                            </div>
                            <div style="font-size: 14px; color: #8b9dc3;">
                                Error: <span style="color: #00ffff; font-family: Orbitron;">${pred.error.toFixed(6)}</span>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('results').innerHTML = html;
                showSuccess(`Scanned ${data.processed} samples`);
                showLoading(false);
            })
            .catch(err => {
                showError('Error in batch scan');
                showLoading(false);
            });
        }
        
        function loadStatistics() {
            showLoading(true);
            
            fetch('/api/statistics')
                .then(r => r.json())
                .then(data => {
                    const cm = data.confusion_matrix;
                    const html = `
                        <h3 style="margin-bottom: 15px; color: #00ffff;">PERFORMANCE METRICS</h3>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">Accuracy</div>
                                <div class="metric-value">${(data.accuracy * 100).toFixed(2)}%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Precision</div>
                                <div class="metric-value">${(data.precision * 100).toFixed(2)}%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Recall</div>
                                <div class="metric-value">${(data.recall * 100).toFixed(2)}%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">F1-Score</div>
                                <div class="metric-value">${data.f1_score.toFixed(4)}</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding: 20px; background: rgba(10,14,39,0.5); border-radius: 10px; border: 1px solid rgba(0,255,255,0.2);">
                            <h4 style="margin-bottom: 10px; color: #00ffff;">CONFUSION MATRIX</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                                <div>True Negatives: <strong style="color: #00ff88;">${cm.tn}</strong></div>
                                <div>False Positives: <strong style="color: #ff0055;">${cm.fp}</strong></div>
                                <div>False Negatives: <strong style="color: #ff0055;">${cm.fn}</strong></div>
                                <div>True Positives: <strong style="color: #00ff88;">${cm.tp}</strong></div>
                            </div>
                        </div>
                    `;
                    document.getElementById('results').innerHTML = html;
                    showLoading(false);
                })
                .catch(err => {
                    showError('Error loading statistics');
                    showLoading(false);
                });
        }
        
        function exportReport() {
            showLoading(true);
            fetch('/api/export-report')
                .then(r => r.json())
                .then(data => {
                    showSuccess(data.message + ' (with XAI insights)');
                    showLoading(false);
                })
                .catch(err => {
                    showError('Error exporting report');
                    showLoading(false);
                });
        }
    </script>
</body>
</html>
